<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB R2020a"><title>Untitled</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: normal; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 17px; font-weight: 700; text-align: left;  }
.CodeBlock { background-color: #F7F7F7; margin: 10px 0 10px 0;}
.S1 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 1px solid rgb(233, 233, 233); border-bottom: 0px none rgb(0, 0, 0); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 17.234px; min-height: 18px; white-space: normal; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S2 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 0px none rgb(0, 0, 0); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 17.234px; min-height: 18px; white-space: normal; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S3 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 1px solid rgb(233, 233, 233); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 17.234px; min-height: 18px; white-space: normal; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }</style></head><body><div class = rtcContent><h3  class = 'S0'><span>Listing 9.7</span></h3><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: normal;"><span>clear</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>clc</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>close </span><span style="color: rgb(160, 32, 240);">all</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>start</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>P</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>ln</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>Pa</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>Pb</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>cxx</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>cyy</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>czz</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>cimg</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>nxx</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>nyy</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>nzz</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>nimg</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>ORxmag</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">global </span><span>fh</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(60, 118, 61);">% We have 3 angles to compute:</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(60, 118, 61);">% - alfa at A about the Z axis from the Y axis</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(60, 118, 61);">% - beta at A about the X axis from the horizontal</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(60, 118, 61);">% - gamma at B about the X axis</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>fh = fopen(</span><span style="color: rgb(160, 32, 240);">'debug.log'</span><span>,</span><span style="color: rgb(160, 32, 240);">'w'</span><span>);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>fprintf(fh, </span><span style="color: rgb(160, 32, 240);">'%10s%10s%10s%10s\n\n'</span><span>, </span><span style="color: rgb(160, 32, 240);">'step'</span><span>,</span><span style="color: rgb(160, 32, 240);">'alpha'</span><span>,</span><span style="color: rgb(160, 32, 240);">'beta'</span><span>,</span><span style="color: rgb(160, 32, 240);">'gamma'</span><span>);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>start = 90; </span><span style="color: rgb(60, 118, 61);">% inital guess at solution</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>ln = 30;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nw = 3;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nr = 2;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>facets = 10;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>[cxx cyy czz] = cylinder([1 1], facets); </span><span style="color: rgb(60, 118, 61);">% arms</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>czz(2,:) = ln;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>[r, c] = size(cxx);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>cimg = zeros(r, c, 3);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>cimg = cimg + 0.8;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>[xx yy zz] = cylinder([nr nr], facets); </span><span style="color: rgb(60, 118, 61);">% nodes</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nxx = zz;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nyy = yy;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nzz = xx;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nxx = nxx*nw - nw/2;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nzr = zeros(1,facets+1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nxx = [nzr-nw/2; nxx; nzr+nw/2];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nyy = [nzr; nyy; nzr];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nzz = [nzr; nzz; nzr];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>[nr, nc] = size(nxx);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nimg = zeros(nr, nc, 3);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>nimg = nimg + 0.8;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>Pa = [10 -20 32];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>Pb = [-3, 40, 0];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>t = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>results = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>ok = true;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">while </span><span>ok &amp;&amp; t &lt;= 1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    P = Pa + (Pb - Pa).*t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% find alfa</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">try</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        [alfa, beta, gamma] = get_angles();</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">catch</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        ok = false;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    res.alf = alfa;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    res.bet = beta;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    res.gam = gamma;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    res.P = P;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    results = [results res];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    fprintf(fh, </span><span style="color: rgb(160, 32, 240);">'%10.4f%10.2f%10.2f%10.2f\n'</span><span>, t, alfa, beta, gamma);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    t = t + 0.01;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>fclose(fh);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>draw_stuff(results)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: normal;"><span>    </span></span></div></div></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">function </span><span>draw_stuff(res)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>Pa</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>Pb</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>cxx</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>cyy</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>czz</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>cimg</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>nxx</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>nyy</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>nzz</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>nimg</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    figure</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    set(gca,</span><span style="color: rgb(160, 32, 240);">'nextplot'</span><span>,</span><span style="color: rgb(160, 32, 240);">'replacechildren'</span><span>);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% Create a video writer object for the output video file and open the object for writing.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    v = VideoWriter(</span><span style="color: rgb(160, 32, 240);">'robot_arm.mp4'</span><span>);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    open(v);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% Generate a set of frames, get the frame from the figure, and then write each frame to the file.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">for </span><span>rndx = 1:length(res)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        alfa = res(rndx).alf;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        beta = res(rndx).bet;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        gamma = res(rndx).gam;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        P = res(rndx).P;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        plot3([Pa(1) Pb(1)],[Pa(2) Pb(2)],[Pa(3) Pb(3)], </span><span style="color: rgb(160, 32, 240);">'rs--'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        hold </span><span style="color: rgb(160, 32, 240);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        plot3(P(1), P(2), P(3), </span><span style="color: rgb(160, 32, 240);">'g*'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span><span style="color: rgb(60, 118, 61);">% fixed infrastructure</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span><span style="color: rgb(60, 118, 61);">% cylinder base</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        N = 100;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        [bxx byy bzz] = cylinder([1 1], N);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bxx = [zeros(1,N+1); bxx; zeros(1,N+1)];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        byy = [zeros(1,N+1); byy; zeros(1,N+1)];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bzz = [zeros(1,N+1); bzz; ones(1,N+1)];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        [r c] = size(bxx);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg = zeros(r, c, 3);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg(:,:,1) = 0.7;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg(:,:,2) = 0.7;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg(:,:,3) = 0.2;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        surf(bxx*3, byy*3, bzz*5-5, bimg)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span><span style="color: rgb(60, 118, 61);">% cube</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bxx = [ 0 0 0 0 0</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        -1 -1 1 1 -1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        -1 -1 1 1 -1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        0 0 0 0 0] * 5;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        byy = [ 0 0 0 0 0</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        1 -1 -1 1 1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        1 -1 -1 1 1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        0 0 0 0 0] * 5;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bzz = [ 1 1 1 1 1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        1 1 1 1 1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        -1 -1 -1 -1 -1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        -1 -1 -1 -1 -1] * 5;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        [r c] = size(bxx);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg = zeros(r, c, 3);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg(:,:,1) = 0.5;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg(:,:,2) = 0.5;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bimg(:,:,3) = 0.2;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        surf(bxx, byy, bzz-10, bimg)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        shading </span><span style="color: rgb(160, 32, 240);">interp</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        surf_rotated(nxx, nyy, nzz, nimg, 180 - alfa, 0, [0 0 0]); </span><span style="color: rgb(60, 118, 61);">% plug A</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        nd1 = surf_rotated(cxx, cyy, czz, cimg, 180 - alfa, 90-beta, [0 0 0]); </span><span style="color: rgb(60, 118, 61);">% line E-A</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        surf_rotated(nxx+nd1(1), nyy+nd1(2), nzz+nd1(3), </span><span style="color: rgb(0, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        nimg, 180 - alfa, 0, nd1); </span><span style="color: rgb(60, 118, 61);">% plug E</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        nd2 = surf_rotated(cxx+nd1(1), cyy+nd1(2), czz+nd1(3), </span><span style="color: rgb(0, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        cimg, 180 - alfa, 90 - gamma, nd1); </span><span style="color: rgb(60, 118, 61);">% line E-F % line E-F</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        surf_rotated(nxx+nd2(1), nyy+nd2(2), nzz+nd2(3), nimg, 180 - alfa, 0, nd2); </span><span style="color: rgb(60, 118, 61);">% plug F</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        axis </span><span style="color: rgb(160, 32, 240);">equal</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span><span style="color: rgb(60, 118, 61);">% axis off</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        xlabel(</span><span style="color: rgb(160, 32, 240);">'X axis'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        ylabel(</span><span style="color: rgb(160, 32, 240);">'Y axis'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        zlabel(</span><span style="color: rgb(160, 32, 240);">'Z axis'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        shading </span><span style="color: rgb(160, 32, 240);">interp</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        material </span><span style="color: rgb(160, 32, 240);">metal</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        grid </span><span style="color: rgb(160, 32, 240);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        lightangle(-45, 45)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        lightangle(45, 45)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        view(-120,40)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        hold </span><span style="color: rgb(160, 32, 240);">off</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        frame = getframe(gcf);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        writeVideo(v,frame);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        pause(0.03)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    close(v);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">function </span><span>[alf bet gam] = get_angles()</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>start</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>P</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>ORxmag</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>ln</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>fh</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% alpha is rotation to put P into the plane of the arm motion</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    alf = atan2(P(1), P(2)) * 180/pi;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% create the solution for the equation</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">%</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% 1. horizontal: ln cos b + ln cos g = ORxmag</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% ORxmagf = ln.*(cosd(bet)+cosd(gam))</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% 2. vertical: ln sin b + ln sin g = P(3)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% P3f = ln .* (sind(bet) + sind(gam))</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% 3. algebra: cos g^2 + sin g^2 = 1</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% from 1: cos g = ORxmag/ln - cos b</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% from 2: sin g = P(3)/ln - sin b</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% so in3: (ORxmag/ln - cos b)^2 + (P(3)/ln - sin b)^2 - 1 = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% mult by ln^2:</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% (ORxmag - ln cos b)^2 + (P(3) - ln sin b)^2 - ln^2 = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% simplify:</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% ORxmag^2 - 2 ln ORxmag cos b + ln^2 cos b^2</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% + P(3)^2 - 2 ln P(3) sin b + ln^2 sin b^2 - ln^2 = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% using 3 again:</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% ORxmag^2 + P(3)^2 - 2 ln(ORxmag cos b + P(3) sin b) = 0</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    ORxmag = sqrt(P(1)^2 + P(2)^2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    b = linspace(0, 360, 100);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    y = equation(b);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    plot(b, y)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    grid </span><span style="color: rgb(160, 32, 240);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    title(</span><span style="color: rgb(160, 32, 240);">'intersection equation'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    xlabel(</span><span style="color: rgb(160, 32, 240);">'beta'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    ylabel(</span><span style="color: rgb(160, 32, 240);">'y'</span><span>);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    axis([-100 400 -2000 5000])</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    pause(0.01)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    at = find(b &gt; start);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    at = at(1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    v = y(at);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% starting at at, find the index of b closest to</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% at that has Y value opposite in sign to v = y(at)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% bto is all the b indices whose values are opposite</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% sign from v</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    bto = find(y.* v &lt; 0);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">if </span><span>isempty(bto)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        error(</span><span style="color: rgb(160, 32, 240);">'no solution'</span><span>);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% dist is the index distance from 'at'</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    dist = abs(bto - at);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% ndx is the place on dist where the min occurs</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    [~, ndx] = min(dist);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% bto(ndx) is the index on B closest to the start</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    to = bto(ndx);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">try</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bet = get_zero(b(at), b(to));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">catch</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        error(</span><span style="color: rgb(160, 32, 240);">'early shower'</span><span>)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    gam = atan2(P(3)./ln - sind(bet), ORxmag./ln - cosd(bet))*180/pi;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    start = bet;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">function </span><span>res = get_zero(b1, b2)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">if </span><span>abs(b1-b2) &lt; 0.01</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        res = b1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">else</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        bm = (b1 + b2) ./ 2;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        e1 = equation(b1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        e2 = equation(b2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        em = equation(bm);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span><span style="color: rgb(0, 0, 255);">if </span><span>e1 .* em &gt;= 0</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>            res = get_zero(bm, b2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span><span style="color: rgb(0, 0, 255);">else</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>            res = get_zero(b1, bm);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>        </span><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">function </span><span>fn = equation(bet)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>P</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>ln</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(0, 0, 255);">global </span><span>ORxmag</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    cb = cosd(bet);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    sb = sind(bet);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    fn = ORxmag.^2 + P(3).^2 - 2.*ln.*(ORxmag.*cb + P(3).*sb);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">function </span><span>nd = surf_rotated(xx, yy, zz, img, alpha, beta, offset)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% beta is about x axis</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    A = [cosd(beta) -sind(beta)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    sind(beta) cosd(beta)];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    [r c] = size(xx);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    N = r*c;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    P1(1,:) = reshape(yy-offset(2), 1, N);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    P1(2,:) = reshape(zz-offset(3), 1, N);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    P2 = A * P1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    yy = reshape(P2(1,:), r, c) + offset(2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    zz = reshape(P2(2,:), r, c) + offset(3);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    </span><span style="color: rgb(60, 118, 61);">% alpha is about z axis</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    A = [cosd(alpha) -sind(alpha)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    sind(alpha) cosd(alpha)];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    P1(1,:) = reshape(xx-offset(1), 1, N);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    P1(2,:) = reshape(yy-offset(2), 1, N);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    P2 = A * P1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    xx = reshape(P2(1,:), r, c) + offset(1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    yy = reshape(P2(2,:), r, c) + offset(2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    surf(xx, yy, zz, img);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: normal;"><span>    nd = [mean(xx(2,:)), mean(yy(2,:)), mean(zz(2,:))];</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: normal;"><span style="color: rgb(0, 0, 255);">end</span></span></div></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
% Listing 9.7

clear
clc
close all

global start
global P
global ln
global Pa
global Pb
global cxx
global cyy
global czz
global cimg
global nxx
global nyy
global nzz
global nimg
global ORxmag
global fh
    
% We have 3 angles to compute:
% - alfa at A about the Z axis from the Y axis
% - beta at A about the X axis from the horizontal
% - gamma at B about the X axis
fh = fopen('debug.log','w');
fprintf(fh, '%10s%10s%10s%10s\n\n', 'step','alpha','beta','gamma');
start = 90; % inital guess at solution
ln = 30;
nw = 3;
nr = 2;
facets = 10;
[cxx cyy czz] = cylinder([1 1], facets); % arms
czz(2,:) = ln;
[r, c] = size(cxx);
cimg = zeros(r, c, 3);
cimg = cimg + 0.8;
[xx yy zz] = cylinder([nr nr], facets); % nodes
nxx = zz;
nyy = yy;
nzz = xx;
nxx = nxx*nw - nw/2;
nzr = zeros(1,facets+1);
nxx = [nzr-nw/2; nxx; nzr+nw/2];
nyy = [nzr; nyy; nzr];
nzz = [nzr; nzz; nzr];
[nr, nc] = size(nxx);
nimg = zeros(nr, nc, 3);
nimg = nimg + 0.8;
Pa = [10 -20 32];
Pb = [-3, 40, 0];
t = 0;
results = [];
ok = true;
while ok && t <= 1
    P = Pa + (Pb - Pa).*t;
    % find alfa
    try
        [alfa, beta, gamma] = get_angles();
    catch
        ok = false;
    end
    res.alf = alfa;
    res.bet = beta;
    res.gam = gamma;
    res.P = P;
    results = [results res];
    fprintf(fh, '%10.4f%10.2f%10.2f%10.2f\n', t, alfa, beta, gamma);
    t = t + 0.01;
end
fclose(fh);
draw_stuff(results)
    
    
%%
function draw_stuff(res)
    global Pa
    global Pb
    global cxx
    global cyy
    global czz
    global cimg
    global nxx
    global nyy
    global nzz
    global nimg
    figure
    set(gca,'nextplot','replacechildren');
    % Create a video writer object for the output video file and open the object for writing.
    
    v = VideoWriter('robot_arm.mp4');
    open(v);
    % Generate a set of frames, get the frame from the figure, and then write each frame to the file.
    
    for rndx = 1:length(res)
        alfa = res(rndx).alf;
        beta = res(rndx).bet;
        gamma = res(rndx).gam;
        P = res(rndx).P;
        plot3([Pa(1) Pb(1)],[Pa(2) Pb(2)],[Pa(3) Pb(3)], 'rsREPLACE_WITH_DASH_DASH')
        hold on
        plot3(P(1), P(2), P(3), 'g*')
        
        % fixed infrastructure
        % cylinder base
        N = 100;
        [bxx byy bzz] = cylinder([1 1], N);
        bxx = [zeros(1,N+1); bxx; zeros(1,N+1)];
        byy = [zeros(1,N+1); byy; zeros(1,N+1)];
        bzz = [zeros(1,N+1); bzz; ones(1,N+1)];
        [r c] = size(bxx);
        bimg = zeros(r, c, 3);
        bimg(:,:,1) = 0.7;
        bimg(:,:,2) = 0.7;
        bimg(:,:,3) = 0.2;
        surf(bxx*3, byy*3, bzz*5-5, bimg)
        % cube
        bxx = [ 0 0 0 0 0
        -1 -1 1 1 -1
        -1 -1 1 1 -1
        0 0 0 0 0] * 5;
        byy = [ 0 0 0 0 0
        1 -1 -1 1 1
        1 -1 -1 1 1
        0 0 0 0 0] * 5;
        bzz = [ 1 1 1 1 1
        1 1 1 1 1
        -1 -1 -1 -1 -1
        -1 -1 -1 -1 -1] * 5;
        [r c] = size(bxx);
        bimg = zeros(r, c, 3);
        bimg(:,:,1) = 0.5;
        bimg(:,:,2) = 0.5;
        bimg(:,:,3) = 0.2;
        surf(bxx, byy, bzz-10, bimg)
        shading interp
        surf_rotated(nxx, nyy, nzz, nimg, 180 - alfa, 0, [0 0 0]); % plug A
        nd1 = surf_rotated(cxx, cyy, czz, cimg, 180 - alfa, 90-beta, [0 0 0]); % line E-A
        surf_rotated(nxx+nd1(1), nyy+nd1(2), nzz+nd1(3), ...
        nimg, 180 - alfa, 0, nd1); % plug E
        nd2 = surf_rotated(cxx+nd1(1), cyy+nd1(2), czz+nd1(3), ...
        cimg, 180 - alfa, 90 - gamma, nd1); % line E-F % line E-F
        surf_rotated(nxx+nd2(1), nyy+nd2(2), nzz+nd2(3), nimg, 180 - alfa, 0, nd2); % plug F
        axis equal
        % axis off
        xlabel('X axis')
        ylabel('Y axis')
        zlabel('Z axis')
        shading interp
        material metal
        grid on
        lightangle(-45, 45)
        lightangle(45, 45)
        view(-120,40)
        hold off
        frame = getframe(gcf);
        writeVideo(v,frame);
        pause(0.03)
    end
    close(v);
end


function [alf bet gam] = get_angles()
    global start
    global P
    global ORxmag
    global ln
    global fh
    
    % alpha is rotation to put P into the plane of the arm motion
    alf = atan2(P(1), P(2)) * 180/pi;
    % create the solution for the equation
    %
    % 1. horizontal: ln cos b + ln cos g = ORxmag
    % ORxmagf = ln.*(cosd(bet)+cosd(gam))
    % 2. vertical: ln sin b + ln sin g = P(3)
    % P3f = ln .* (sind(bet) + sind(gam))
    % 3. algebra: cos g^2 + sin g^2 = 1
    % from 1: cos g = ORxmag/ln - cos b
    % from 2: sin g = P(3)/ln - sin b
    % so in3: (ORxmag/ln - cos b)^2 + (P(3)/ln - sin b)^2 - 1 = 0;
    % mult by ln^2:
    % (ORxmag - ln cos b)^2 + (P(3) - ln sin b)^2 - ln^2 = 0;
    % simplify:
    % ORxmag^2 - 2 ln ORxmag cos b + ln^2 cos b^2
    % + P(3)^2 - 2 ln P(3) sin b + ln^2 sin b^2 - ln^2 = 0;
    % using 3 again:
    % ORxmag^2 + P(3)^2 - 2 ln(ORxmag cos b + P(3) sin b) = 0
    ORxmag = sqrt(P(1)^2 + P(2)^2);
    b = linspace(0, 360, 100);
    y = equation(b);
    plot(b, y)
    grid on
    title('intersection equation')
    xlabel('beta')
    ylabel('y');
    axis([-100 400 -2000 5000])
    pause(0.01)
    at = find(b > start);
    at = at(1);
    v = y(at);
    % starting at at, find the index of b closest to
    % at that has Y value opposite in sign to v = y(at)
    % bto is all the b indices whose values are opposite
    % sign from v
    bto = find(y.* v < 0);
    if isempty(bto)
        error('no solution');
    end
    % dist is the index distance from 'at'
    dist = abs(bto - at);
    % ndx is the place on dist where the min occurs
    [~, ndx] = min(dist);
    % bto(ndx) is the index on B closest to the start
    to = bto(ndx);
    try
        bet = get_zero(b(at), b(to));
    catch
        error('early shower')
    end
    gam = atan2(P(3)./ln - sind(bet), ORxmag./ln - cosd(bet))*180/pi;
    start = bet;
end



function res = get_zero(b1, b2)
    if abs(b1-b2) < 0.01
        res = b1;
    else
        bm = (b1 + b2) ./ 2;
        e1 = equation(b1);
        e2 = equation(b2);
        em = equation(bm);
        if e1 .* em >= 0
            res = get_zero(bm, b2);
        else
            res = get_zero(b1, bm);
        end
    end
end


function fn = equation(bet)
    global P
    global ln
    global ORxmag
    cb = cosd(bet);
    sb = sind(bet);
    fn = ORxmag.^2 + P(3).^2 - 2.*ln.*(ORxmag.*cb + P(3).*sb);
end


function nd = surf_rotated(xx, yy, zz, img, alpha, beta, offset)
    % beta is about x axis
    A = [cosd(beta) -sind(beta)
    sind(beta) cosd(beta)];
    [r c] = size(xx);
    N = r*c;
    P1(1,:) = reshape(yy-offset(2), 1, N);
    P1(2,:) = reshape(zz-offset(3), 1, N);
    P2 = A * P1;
    yy = reshape(P2(1,:), r, c) + offset(2);
    zz = reshape(P2(2,:), r, c) + offset(3);
    % alpha is about z axis
    A = [cosd(alpha) -sind(alpha)
    sind(alpha) cosd(alpha)];
    P1(1,:) = reshape(xx-offset(1), 1, N);
    P1(2,:) = reshape(yy-offset(2), 1, N);
    P2 = A * P1;
    xx = reshape(P2(1,:), r, c) + offset(1);
    yy = reshape(P2(2,:), r, c) + offset(2);
    surf(xx, yy, zz, img);
    nd = [mean(xx(2,:)), mean(yy(2,:)), mean(zz(2,:))];
end
##### SOURCE END #####
--></body></html>